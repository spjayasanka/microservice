pipeline {
    agent any

    environment {
        DOCKER_COMPOSE_FILE = 'C:/Users/sanjeewa/Desktop/LEARN/micro service/docker-compose.yml'
    }

    triggers {
        pollSCM('H/1 * * * *')  // Poll the local repository every minute
    }

    stages {
        stage('Checkout') {
            steps {
                // Checkout from the local Git repository
                dir('C:/path/to/your/local/git/repository') {
                    // This clones the code from your local repository
                    sh 'git pull origin master'  // Use pull if your code is already initialized in Jenkins workspace
                }
            }
        }

        stage('Build Microservices') {
            steps {
                script {
                    // Build each microservice using Maven
                    sh './user-service/mvnw clean package -DskipTests'
                    sh './hello-service/mvnw clean package -DskipTests'
                }
            }
        }

        stage('Build Docker Images') {
            steps {
                script {
                    // Build Docker images for each microservice
                    sh 'docker build -t user-service:latest ./user-service'
                    sh 'docker build -t hello-service:latest ./hello-service'
                    sh 'docker build -t api-gateway:latest ./api-gateway'
                    sh 'docker build -t eureka-server:latest ./eureka-server'
                }
            }
        }

        stage('Deploy with Docker Compose') {
            steps {
                script {
                    // Deploy services using Docker Compose
                    sh 'docker-compose -f $DOCKER_COMPOSE_FILE down'
                    sh 'docker-compose -f $DOCKER_COMPOSE_FILE up -d'
                }
            }
        }
    }

    post {
        always {
            sh 'docker image prune -f'
        }
        success {
            echo 'Deployment was successful!'
        }
        failure {
            echo 'Deployment failed. Check the logs for details.'
        }
    }
}
